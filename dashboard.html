<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoopCare</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            margin-bottom: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .chart-title {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .btn-group {
            margin-bottom: 20px;
        }
        .stats-card {
            margin-bottom: 20px;
            text-align: center;
        }
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .stats-label {
            font-size: 1rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PoopCare</h1>
            <p class="text-muted">守护您的粪围感</p>
        </div>

        <!-- 用户选择 -->
        <div class="chart-container">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="userId">用户ID</label>
                        <input type="text" class="form-control" id="userId" placeholder="输入用户ID" value="1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="days">查看天数</label>
                        <select class="form-control" id="days">
                            <option value="7">7天</option>
                            <option value="14">14天</option>
                            <option value="30" selected>30天</option>
                            <option value="90">90天</option>
                        </select>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="loadData()">加载数据</button>
        </div>

        <!-- 统计卡片 -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="avgScore">--</div>
                        <div class="stats-label">平均健康评分</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="totalRecords">--</div>
                        <div class="stats-label">总记录数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="mostCommonColor">--</div>
                        <div class="stats-label">最常见颜色</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="mostCommonShape">--</div>
                        <div class="stats-label">最常见形状</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 健康评分趋势图 -->
        <div class="chart-container">
            <h2 class="chart-title">健康评分趋势</h2>
            <canvas id="healthScoreChart"></canvas>
        </div>

        <!-- 大便颜色分布图 -->
        <div class="chart-container">
            <h2 class="chart-title">大便颜色分布</h2>
            <canvas id="colorDistributionChart"></canvas>
        </div>

        <!-- 大便形状分布图 -->
        <div class="chart-container">
            <h2 class="chart-title">大便形状分布</h2>
            <canvas id="shapeDistributionChart"></canvas>
        </div>

        <!-- 排便感觉分布图 -->
        <div class="chart-container">
            <h2 class="chart-title">排便感觉分布</h2>
            <canvas id="feelingDistributionChart"></canvas>
        </div>

        <!-- 异常情况统计 -->
        <div class="chart-container">
            <h2 class="chart-title">异常情况统计</h2>
            <canvas id="abnormalStatsChart"></canvas>
        </div>
    </div>

    <script>
        // 图表实例
        let healthScoreChart, colorDistributionChart, shapeDistributionChart, feelingDistributionChart, abnormalStatsChart;

        // 颜色映射
        const colorMap = {
            'yellow': '#FFC107',
            'brown': '#795548',
            'dark_brown': '#3E2723',
            'green': '#4CAF50',
            'black': '#212121',
            'red': '#F44336',
            'white': '#FFFFFF',
            'other': '#9E9E9E'
        };

        // 形状映射
        const shapeMap = {
            'type_1': '类型1',
            'type_2': '类型2',
            'type_3': '类型3',
            'type_4': '类型4',
            'type_5': '类型5',
            'type_6': '类型6',
            'type_7': '类型7'
        };

        // 感觉映射
        const feelingMap = {
            'smooth': '顺畅',
            'normal': '正常',
            'difficult': '困难',
            'painful': '疼痛'
        };

        // 加载数据
        async function loadData() {
            const userId = document.getElementById('userId').value;
            const days = document.getElementById('days').value;

            try {
                // 加载健康评分趋势
                const trendResponse = await fetch(`/api/statistics/health-score/trend?days=${days}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken(userId)}`
                    }
                });
                const trendData = await trendResponse.json();
                renderHealthScoreChart(trendData.data);

                // 加载颜色分布
                const colorResponse = await fetch('/api/statistics/distribution/color', {
                    headers: {
                        'Authorization': `Bearer ${getToken(userId)}`
                    }
                });
                const colorData = await colorResponse.json();
                renderColorDistributionChart(colorData.data);

                // 加载形状分布
                const shapeResponse = await fetch('/api/statistics/distribution/shape', {
                    headers: {
                        'Authorization': `Bearer ${getToken(userId)}`
                    }
                });
                const shapeData = await shapeResponse.json();
                renderShapeDistributionChart(shapeData.data);

                // 加载感觉分布
                const feelingResponse = await fetch('/api/statistics/distribution/feeling', {
                    headers: {
                        'Authorization': `Bearer ${getToken(userId)}`
                    }
                });
                const feelingData = await feelingResponse.json();
                renderFeelingDistributionChart(feelingData.data);

                // 加载总体统计
                const overallResponse = await fetch('/api/statistics/overall', {
                    headers: {
                        'Authorization': `Bearer ${getToken(userId)}`
                    }
                });
                const overallData = await overallResponse.json();
                renderStatsCards(overallData.data);
                renderAbnormalStatsChart(overallData.data);

            } catch (error) {
                console.error('加载数据失败:', error);
                alert('加载数据失败，请检查网络连接或用户ID是否正确');
            }
        }

        // 生成测试Token（实际环境中应该从后端获取）
        function getToken(userId) {
            // 这里使用简单的JWT格式，实际环境中应该由后端生成
            const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
            const payload = btoa(JSON.stringify({ id: userId, username: 'testuser', exp: Date.now() + 3600000 }));
            const signature = btoa('test-signature');
            return `${header}.${payload}.${signature}`;
        }

        // 渲染健康评分趋势图
        function renderHealthScoreChart(data) {
            const ctx = document.getElementById('healthScoreChart').getContext('2d');
            
            if (healthScoreChart) {
                healthScoreChart.destroy();
            }
            
            healthScoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.trend.map(item => item.date),
                    datasets: [{
                        label: '健康评分',
                        data: data.trend.map(item => item.score),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // 渲染颜色分布图
        function renderColorDistributionChart(data) {
            const ctx = document.getElementById('colorDistributionChart').getContext('2d');
            
            const labels = Object.keys(data.color_distribution);
            const values = labels.map(label => data.color_distribution[label].count);
            const colors = labels.map(label => colorMap[label] || '#9E9E9E');
            
            if (colorDistributionChart) {
                colorDistributionChart.destroy();
            }
            
            colorDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 渲染形状分布图
        function renderShapeDistributionChart(data) {
            const ctx = document.getElementById('shapeDistributionChart').getContext('2d');
            
            const labels = Object.keys(data.shape_distribution).map(shape => shapeMap[shape] || shape);
            const values = Object.keys(data.shape_distribution).map(shape => data.shape_distribution[shape].count);
            
            if (shapeDistributionChart) {
                shapeDistributionChart.destroy();
            }
            
            shapeDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '记录数',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // 渲染排便感觉分布图
        function renderFeelingDistributionChart(data) {
            const ctx = document.getElementById('feelingDistributionChart').getContext('2d');
            
            const labels = Object.keys(data.feeling_distribution).map(feeling => feelingMap[feeling] || feeling);
            const values = Object.keys(data.feeling_distribution).map(feeling => data.feeling_distribution[feeling].count);
            
            if (feelingDistributionChart) {
                feelingDistributionChart.destroy();
            }
            
            feelingDistributionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#4CAF50',
                            '#2196F3',
                            '#FF9800',
                            '#F44336'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // 渲染异常情况统计
        function renderAbnormalStatsChart(data) {
            const ctx = document.getElementById('abnormalStatsChart').getContext('2d');
            
            const labels = Object.keys(data.abnormal_stats);
            const values = Object.values(data.abnormal_stats);
            
            if (abnormalStatsChart) {
                abnormalStatsChart.destroy();
            }
            
            abnormalStatsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '异常次数',
                        data: values,
                        backgroundColor: 'rgba(244, 67, 54, 0.8)',
                        borderColor: 'rgba(244, 67, 54, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // 渲染统计卡片
        function renderStatsCards(data) {
            document.getElementById('avgScore').textContent = data.average_health_score || '--';
            document.getElementById('totalRecords').textContent = data.total_records || '--';
            document.getElementById('mostCommonColor').textContent = data.most_common_color || '--';
            document.getElementById('mostCommonShape').textContent = data.most_common_shape || '--';
        }

        // 页面加载时自动加载数据
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>